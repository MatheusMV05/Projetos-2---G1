<!DOCTYPE html>
<html lang="pt-br">

<head>
	<meta charset="UTF-8" />
	<meta name="viewport" content="width=device-width, initial-scale=1.0" />
	{% load static %}
	<title>Dashboard</title>
	<link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/css/bootstrap.min.css" rel="stylesheet"
		crossorigin="anonymous">
	<link rel="stylesheet" href="{% static 'css/styles.css' %}" />
	<link rel="stylesheet" href="{% static 'css/dashboard.css' %}" />
	<style>
		.card-clickable {
			cursor: pointer;
			transition: transform 0.2s;
		}

		.card-clickable:hover {
			transform: scale(1.05);
		}

		.card-clima-atual {
			width: 20rem;
			position: absolute;
			top: 180px;
			right: 20px;
		}
	</style>
</head>

<body>
	<!-- Cabe√ßalho com logo e √≠cones -->
	<div class="header-container">
		<header>
			<div class="menu-abrir" id="menu-abrir">
				<img src="{% static 'img/menu-line.svg' %}" alt="Abrir menu" />
			</div>
			<div class="menu-mobile" id="menu-mobile">
				<div class="menu-fechar">
					<img src="{% static 'img/close-large-line.svg' %}" alt="Fechar menu" />
				</div>
				<nav class="mobile">
					<ul>
						<li><a href="{% url 'insumos_view' %}">Insumos</a></li>
						<li><a href="{% url 'demandas_comerciais' %}">Demandas Comerciais</a></li>
					</ul>
				</nav>
			</div>
			<nav class="nav-logo">
				<div class="logo">
					<img src="{% static 'img/Logomarca Horizontal.svg' %}" alt="Logomarca" />
				</div>
			</nav>
			<nav class="nav-user">
				<div class="user">
					<img src="{% static 'img/user.svg' %}" alt="Usu√°rio" />
				</div>
			</nav>
		</header>
	</div>
	<h2>Bem-vindo,<br><span>{{ user.nome }}</span></h2>
	<br>

	<!-- Clima Atual -->
	<div class="card card-clickable card-clima-atual shadow-sm" role="button" data-bs-toggle="modal"
		data-bs-target="#modalPrevisao">
		<div class="card-header bg-primary text-white">
			<h4 class="mb-0 text-center">üå°Ô∏è Clima Atual</h4>
		</div>
		<div class="card-body text-center">
			<p id="temperatura"><strong>Temperatura:</strong> --</p>
			<p id="descricao"><strong>Descri√ß√£o:</strong> --</p>
			<img id="imagem-lua" src="{% static 'img/new.png' %}" alt="Fase da Lua" class="img-fluid"
				style="max-width: 50px;" />
			<p id="nome-fase"></p>
		</div>
	</div>

	<!-- Modal para Previs√£o dos Pr√≥ximos Dias -->
	<div class="modal fade" id="modalPrevisao" tabindex="-1" aria-labelledby="modalPrevisaoLabel" aria-hidden="true">
		<div class="modal-dialog modal-lg">
			<div class="modal-content">
				<div class="modal-header bg-success text-white">
					<h5 class="modal-title" id="modalPrevisaoLabel">üå§Ô∏è Previs√£o dos Pr√≥ximos Dias</h5>
					<button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
				</div>
				<div class="modal-body">
					<div id="previsao-dias" class="row">
						<!-- Previs√£o ser√° carregada dinamicamente aqui -->
					</div>
				</div>
				<div class="modal-footer">
					<button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Fechar</button>
				</div>
			</div>
		</div>
	</div>
	</div>

	<h2>Minhas tarefas</h2>
	<br>
	<div id="pendentes-section">
		{% for planta, tarefas in tarefas_do_dia.items %}

		<!--Minhas tarefas-->
		<div class="planta-section mb-3" style="display: inline-block;">
			<ul class="list-group" id="pendentes-list" style="padding: 0; list-style: none;">
				{% for tarefa in tarefas %}
				<li class="list-group-item d-flex" style="
						display: inline-block;
						height: 112px;
						width: 128px;
						border-radius: 16px;
						background: #ffffff;
						box-shadow: 0px 0px 16px -4px rgba(0, 0, 0, 0.25);
						vertical-align: top; /* Alinha os itens ao topo */
						margin-right: 16px; /* Espa√ßo entre os itens */
						margin-left: 19px;
						text-align: center;
					">
					<span class="task-title"
						onclick="showTaskDetails('{{ tarefa.tipo_acao }}', '{{ tarefa.descricao }}', '{{ tarefa.planta }}')">
						{{ tarefa.tipo_acao }} <br />
						{{ tarefa.planta }}
					</span>
					<input type="checkbox" class="checkbox" onclick="toggleTaskCompletion(this)" />
				</li>
				{% endfor %}
			</ul>
		</div>
	</div>
	{% empty %}
	<p class="text-muted">N√£o h√° tarefas programadas para hoje.</p>
	{% endfor %}
	</div>

	<br>
	<h2>Meu plantio</h2>
	<br>
	<h2>Meu celeiro</h2>
	<!-- Bot√£o Fixo para o Chat -->
<button id="gemini-chat-btn" class="btn btn-primary" style="position: fixed; bottom: 20px; right: 20px; z-index: 1000;">
    üí¨ Fale com o Bento
</button>

<!-- Modal para o Chat -->
<div id="gemini-chat-modal" class="modal" tabindex="-1" style="display: none;">
    <div class="modal-dialog">
        <div class="modal-content">
            <div class="modal-header">
                <h5 class="modal-title">Bento chat</h5>
                <button type="button" class="btn-close" onclick="closeChat()"></button>
            </div>
            <div class="modal-body">
                <div id="chat-messages" style="height: 300px; overflow-y: auto; border: 1px solid #ddd; padding: 10px;"></div>
                <div class="input-group mt-3">
                    <input id="chat-input" type="text" class="form-control" placeholder="Digite sua mensagem">
                    <button class="btn btn-success" onclick="sendMessage()">Enviar</button>
                </div>
            </div>
        </div>
    </div>
</div>


	<script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/js/bootstrap.bundle.min.js" crossorigin="anonymous"></script>
	<script>
		function obterLocalizacao() {
			if (navigator.geolocation) {
				navigator.geolocation.getCurrentPosition(
					function (position) {
						const latitude = position.coords.latitude;
						const longitude = position.coords.longitude;

						fetch("{% url 'dashboard' %}", {
							method: "POST",
							headers: {
								"Content-Type": "application/json",
								"X-CSRFToken": "{{ csrf_token }}",
							},
							body: JSON.stringify({ latitude, longitude }),
						})
							.then((response) => response.json())
							.then((data) => {
								console.log("Dados recebidos:", data);

								// Atualiza o clima atual
								if (data.clima_atual) {
									document.getElementById("temperatura").innerText = `Temperatura: ${data.clima_atual.temperatura}¬∞C`;
									document.getElementById("descricao").innerText = `Descri√ß√£o: ${data.clima_atual.descricao}`;
									const faseDaLua = data.clima_atual.fase_da_lua.toLowerCase().replace(/ /g, "_");
									document.getElementById("imagem-lua").src = `{% static 'img/' %}${faseDaLua}.png`;
									document.getElementById("nome-fase").innerText = `Fase da Lua: ${data.clima_atual.fase_da_lua}`;
								} else {
									console.error("Dados de clima atual ausentes.");
								}

								// Atualiza a previs√£o dos pr√≥ximos dias no modal
								if (data.previsao_dias) {
									const previsaoContainer = document.getElementById("previsao-dias");
									previsaoContainer.innerHTML = ""; // Limpa o conte√∫do anterior
									data.previsao_dias.forEach((dia) => {
										const diaHtml = `
											<div class="col-md-4 mb-3">
												<div class="card shadow-sm">
													<div class="card-body text-center">
														<h5>${dia.dia}</h5>
														<p><strong>${dia.descricao}</strong></p>
														<p>Min: ${dia.min}¬∞C</p>
														<p>Max: ${dia.max}¬∞C</p>
													</div>
												</div>
											</div>
										`;
										previsaoContainer.insertAdjacentHTML("beforeend", diaHtml);
									});
									console.log("Previs√£o dos pr√≥ximos dias carregada no modal.");
								} else {
									console.warn("Nenhuma previs√£o dos pr√≥ximos dias encontrada.");
								}
							})
							.catch((error) => console.error("Erro ao obter dados do clima:", error));
					},
					(error) => console.error("Erro ao obter localiza√ß√£o:", error)
				);
			} else {
				console.error("Geolocaliza√ß√£o n√£o √© suportada pelo navegador.");
			}
		}

		// Carregar dados ao iniciar a p√°gina
		window.onload = obterLocalizacao;
	</script>

<script>
    const chatBtn = document.getElementById('gemini-chat-btn');
	const chatModal = document.getElementById('gemini-chat-modal');
	const chatMessages = document.getElementById('chat-messages');
	const chatInput = document.getElementById('chat-input');

// Fun√ß√£o para rolar para o final do chat
function scrollToBottom() {
    chatMessages.scrollTop = chatMessages.scrollHeight;
}

// Fun√ß√£o para abrir o chat
chatBtn.onclick = async () => {
    chatModal.style.display = 'block';
    chatInput.focus();

    // Solicitar a mensagem inicial do Bento
    try {
        const response = await fetch("{% url 'dashboard' %}", {
            method: "POST",
            headers: {
                "Content-Type": "application/json",
                "X-CSRFToken": "{{ csrf_token }}",
            },
            body: JSON.stringify({ is_initial: true }), // Envia o sinalizador para a mensagem inicial
        });

        if (response.ok) {
            const data = await response.json();
            if (data.reply) {
                chatMessages.innerHTML += `<div class="chat-message bento"><strong>Bento:</strong> ${data.reply}</div>`;
                scrollToBottom();
            }
        } else {
            console.error(`Erro ao carregar mensagem inicial: ${response.status} - ${response.statusText}`);
        }
    } catch (error) {
        console.error("Erro ao carregar mensagem inicial:", error);
        chatMessages.innerHTML += `<div class="chat-message bento"><strong>Bento:</strong> N√£o consegui iniciar a conversa.</div>`;
    }
};

// Fun√ß√£o para fechar o chat
function closeChat() {
    chatModal.style.display = 'none';
}

// Fun√ß√£o para enviar mensagem
async function sendMessage() {
    const message = chatInput.value.trim();
    if (!message) return;

    // Mostra a mensagem do usu√°rio
    chatMessages.innerHTML += `<div class="chat-message user"><strong>Voc√™:</strong> ${message}</div>`;
    chatInput.value = '';

    // Envia a mensagem para o backend
    try {
        const response = await fetch("{% url 'dashboard' %}", {
            method: "POST",
            headers: {
                "Content-Type": "application/json",
                "X-CSRFToken": "{{ csrf_token }}",
            },
            body: JSON.stringify({ chat_message: message }),
        });

        if (response.ok) {
            const data = await response.json();
            if (data.reply) {
                chatMessages.innerHTML += `<div class="chat-message bento"><strong>Bento:</strong> ${data.reply}</div>`;
            } else {
                chatMessages.innerHTML += `<div class="chat-message bento"><strong>Bento:</strong> N√£o consegui entender sua mensagem.</div>`;
            }
        } else {
            chatMessages.innerHTML += `<div class="chat-message bento"><strong>Bento:</strong> Houve um problema ao processar sua mensagem.</div>`;
            console.error(`Erro ao enviar mensagem: ${response.status} - ${response.statusText}`);
        }
    } catch (error) {
        chatMessages.innerHTML += `<div class="chat-message bento"><strong>Bento:</strong> Erro ao se comunicar com o servidor.</div>`;
        console.error("Erro ao enviar mensagem:", error);
    }

    scrollToBottom(); // Rola para o final ap√≥s cada mensagem
}
</script>


	<script src="{% static 'js/dashboard.js' %}"></script>



</body>


</html>